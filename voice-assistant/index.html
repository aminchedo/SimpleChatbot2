<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هوش مصنوعی فارسی | دستیار هوشمند گفتگو</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --user-primary: #4d5ecc;
            --user-secondary: #6979de;
            --user-gradient: linear-gradient(135deg, #4d5ecc, #3949ab);
            --user-shadow: 0 8px 20px rgba(77, 94, 204, 0.25);
            --user-glow: 0 0 15px rgba(77, 94, 204, 0.2);
            --ai-primary: #10b3d6;
            --ai-secondary: #0091ea;
            --ai-gradient: linear-gradient(135deg, #10b3d6, #0091ea);
            --ai-shadow: 0 8px 20px rgba(16, 179, 214, 0.25);
            --ai-glow: 0 0 15px rgba(16, 179, 214, 0.15);
            --bg-gradient: linear-gradient(135deg, #f8faff 0%, #e4eaf5 100%);
            --surface-primary: #ffffff;
            --surface-secondary: #f8f9fd;
            --surface-tertiary: #f0f4fd;
            --text-primary: rgba(18, 25, 41, 0.95);
            --text-secondary: rgba(18, 25, 41, 0.75);
            --text-tertiary: rgba(18, 25, 41, 0.55);
            --text-on-primary: #ffffff;
            --error-color: #e53935;
            --success-color: #2ece71;
            --warning-color: #f5b041;
            --recording-color: #e53935;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 16px 32px rgba(0, 0, 0, 0.16);
            --shadow-focus: 0 0 0 3px rgba(77, 94, 204, 0.25);
            --transition-fast: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-normal: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-slow: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius-sm: 8px;
            --border-radius-md: 16px;
            --border-radius-lg: 24px;
            --border-radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, sans-serif;
        }

        body {
            background: var(--bg-gradient);
            block-size: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
        }

        .chat-container {
            inline-size: 95%;
            max-inline-size: 1200px;
            block-size: 92vh;
            display: flex;
            flex-direction: column;
            background-color: var(--surface-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: var(--transition-normal);
            position: relative;
        }

        .chat-container:hover {
            box-shadow: var(--shadow-lg), var(--user-glow);
        }

        .chat-header {
            background: var(--user-gradient);
            color: var(--text-on-primary);
            padding: 18px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
            position: relative;
            overflow: hidden;
            border-block-end: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-header::before {
            content: '';
            position: absolute;
            inset-block-start: 0;
            inset-inline-start: 0;
            inset-inline-end: 0;
            inset-block-end: 0;
            background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.4rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
        }

        .model-selector {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .model-selector select {
            background: transparent;
            border: none;
            color: white;
            font-size: 0.9rem;
            padding: 0 4px;
            outline: none;
            cursor: pointer;
        }

        .model-selector select option {
            background: #4d5ecc;
            color: white;
        }

        .header-controls {
            display: flex;
            gap: 15px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-on-primary);
            border: none;
            border-radius: var(--border-radius-full);
            inline-size: 42px;
            block-size: 42px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition-normal);
            font-size: 1rem;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .connection-status {
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--error-color);
        }

        .status-indicator.online {
            background-color: var(--success-color);
        }

        .ai-logo-container {
            inline-size: 35px;
            block-size: 35px;
            position: relative;
        }

        .ai-logo {
            inline-size: 35px;
            block-size: 35px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            animation: pulse-logo 4s infinite ease-in-out;
        }

        @keyframes pulse-logo {
            0% { transform: scale(1); filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)); }
            50% { transform: scale(1.08); filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4)); }
            100% { transform: scale(1); filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)); }
        }

        .chat-messages {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: var(--surface-secondary);
            background-image: radial-gradient(circle at 2px 2px, rgba(0, 0, 0, 0.03) 1px, transparent 0);
            background-size: 30px 30px;
            scroll-behavior: smooth;
            gap: 30px;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-inline-size: 80%;
            animation: fadeIn 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            align-items: flex-end;
            margin-inline-start: auto;
        }

        .message-ai {
            align-items: flex-start;
            margin-inline-end: auto;
        }

        .message-content {
            padding: 20px 25px;
            border-radius: var(--border-radius-md);
            position: relative;
            line-height: 1.8;
            word-break: break-word;
            transition: var(--transition-normal);
            font-size: 1.05rem;
            overflow: hidden;
        }

        .message-content p {
            margin-block-end: 15px;
        }

        .message-content p:last-child {
            margin-block-end: 0;
        }

        .user-message {
            background: var(--user-gradient);
            color: var(--text-on-primary);
            border-start-end-radius: 4px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
            box-shadow: var(--user-shadow);
        }

        .user-message::before {
            content: '';
            position: absolute;
            inset-block-start: 0;
            inset-inline-start: 0;
            inset-inline-end: 0;
            inset-block-end: 0;
            background: radial-gradient(circle at 90% 10%, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .ai-message {
            background: var(--surface-primary);
            color: var(--text-primary);
            border-start-start-radius: 4px;
            box-shadow: var(--shadow-md);
            border-block-end: 2px solid var(--ai-primary);
        }

        .ai-message::before {
            content: '';
            position: absolute;
            inset-inline-start: 0;
            inset-block-start: 0;
            inline-size: 4px;
            block-size: 100%;
            background: var(--ai-gradient);
            border-start-start-radius: 4px;
            border-end-start-radius: 4px;
        }

        .message-metadata {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-block-start: 8px;
            padding: 0 5px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .message-time {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message-sender {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-sender {
            color: var(--user-primary);
        }

        .ai-sender {
            color: var(--ai-primary);
        }

        .sender-icon {
            inline-size: 16px;
            block-size: 16px;
        }

        .input-container {
            padding: 25px;
            background-color: var(--surface-primary);
            border-block-start: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 5;
        }

        .input-controls {
            display: flex;
            gap: 12px;
            margin-block-end: 15px;
            justify-content: center;
        }

        .input-control-btn {
            background: var(--surface-tertiary);
            color: var(--text-secondary);
            border: none;
            border-radius: var(--border-radius-md);
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition-normal);
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .input-control-btn::before {
            content: '';
            position: absolute;
            inset-block-start: 0;
            inset-inline-start: 0;
            inline-size: 100%;
            block-size: 100%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: var(--transition-normal);
        }

        .input-control-btn:hover {
            background: var(--surface-tertiary);
            color: var(--user-primary);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transform: translateY(-3px);
        }

        .input-control-btn:hover::before {
            opacity: 1;
        }

        #record-button {
            background: linear-gradient(to bottom, #f0f4ff, #e6ebfc);
            border-inline-start: 3px solid var(--user-primary);
        }

        #attach-button {
            background: linear-gradient(to bottom, #f0f8ff, #e6f4fc);
            border-inline-start: 3px solid var(--ai-primary);
        }

        #emoji-button {
            background: linear-gradient(to bottom, #fff8f0, #fcf4e6);
            border-inline-start: 3px solid #f5b041;
        }

        .input-wrapper {
            display: flex;
            gap: 15px;
            inline-size: 100%;
            align-items: flex-end;
            position: relative;
        }

        .text-input-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--surface-tertiary);
            border-radius: var(--border-radius-md);
            padding: 15px 20px;
            padding-inline-end: 60px;
            transition: var(--transition-normal);
            border: 2px solid transparent;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .text-input-container:focus-within {
            border-color: var(--user-primary);
            box-shadow: var(--shadow-focus);
        }

        .text-input-container::before {
            content: '';
            position: absolute;
            inset-block-start: 0;
            inset-inline-start: 0;
            inline-size: 100%;
            block-size: 100%;
            background: linear-gradient(to right, transparent, var(--surface-tertiary) 15%, var(--surface-tertiary) 85%, transparent);
            pointer-events: none;
            z-index: 1;
        }

        .text-input-container > * {
            position: relative;
            z-index: 2;
        }

        #user-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 0;
            font-size: 1.05rem;
            outline: none;
            resize: none;
            block-size: auto;
            min-block-size: 24px;
            max-block-size: 150px;
            overflow-y: auto;
            color: var(--text-primary);
            line-height: 1.7;
        }

        #user-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-button {
            position: absolute;
            inset-inline-end: 12px;
            inset-block-end: 12px;
            inline-size: 40px;
            block-size: 40px;
            border-radius: var(--border-radius-full);
            cursor: pointer;
            transition: var(--transition-normal);
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--user-gradient);
            color: var(--text-on-primary);
            box-shadow: var(--user-shadow);
            z-index: 3;
        }

        .send-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(77, 94, 204, 0.4);
        }

        .emoji-button {
            position: absolute;
            inset-inline-end: 60px;
            inset-block-end: 12px;
            inline-size: 40px;
            block-size: 40px;
            border-radius: var(--border-radius-full);
            cursor: pointer;
            transition: var(--transition-normal);
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--warning-color);
            color: var(--text-on-primary);
            box-shadow: var(--shadow-sm);
            z-index: 3;
        }

        .emoji-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(245, 176, 65, 0.4);
        }

        .emoji-picker {
            position: absolute;
            inset-block-end: 70px;
            inset-inline-end: 20px;
            background: var(--surface-primary);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            padding: 15px;
            display: none;
            z-index: 10;
            max-block-size: 300px;
            overflow-y: auto;
        }

        .emoji-picker.active {
            display: block;
        }

        .emoji-picker span {
            font-size: 1.5rem;
            padding: 5px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .emoji-picker span:hover {
            transform: scale(1.2);
        }

        .voice-wave {
            display: flex;
            gap: 2px;
            margin-block-end: 10px;
        }

        .wave-bar {
            inline-size: 4px;
            background: var(--recording-color);
            border-radius: var(--border-radius-full);
            animation: wave 0.8s infinite ease-in-out;
        }

        @keyframes wave {
            0%, 100% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
        }

        .interim-result {
            color: var(--text-tertiary);
            font-size: 0.9rem;
            margin-block-start: 5px;
            display: none;
        }

        .interim-result.active {
            display: block;
        }

        .attachment-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-block-start: 15px;
            background: var(--surface-tertiary);
            padding: 10px 15px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
        }

        .file-icon {
            font-size: 1.5rem;
            color: var(--text-secondary);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
        }

        .file-size {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .remove-file {
            background: var(--error-color);
            color: var(--text-on-primary);
            border: none;
            border-radius: var(--border-radius-full);
            inline-size: 30px;
            block-size: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition-normal);
        }

        .remove-file:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(229, 57, 53, 0.4);
        }

        .stop-generation {
            background: var(--error-color);
            color: var(--text-on-primary);
            border: none;
            border-radius: var(--border-radius-md);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition-normal);
            margin-block-end: 15px;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }

        .stop-generation:hover {
            background: #d32f2f;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(229, 57, 53, 0.4);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            background: var(--surface-tertiary);
            border-radius: var(--border-radius-md);
            max-inline-size: 200px;
            margin-inline-end: auto;
        }

        .typing-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .typing-dots {
            display: flex;
            gap: 5px;
        }

        .typing-dot {
            inline-size: 8px;
            block-size: 8px;
            background: var(--ai-primary);
            border-radius: var(--border-radius-full);
            animation: typing 1s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .code-block {
            position: relative;
            background: #2d2d2d;
            color: #ffffff;
            padding: 15px;
            border-radius: var(--border-radius-sm);
            margin-block: 10px;
            overflow-x: auto;
        }

        .copy-code {
            position: absolute;
            inset-inline-start: 10px;
            inset-block-start: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: var(--transition-normal);
        }

        .copy-code:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .system-message {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            padding: 10px;
            background: var(--surface-tertiary);
            border-radius: var(--border-radius-md);
            margin: 10px auto;
            max-inline-size: 50%;
        }

        .error-message {
            text-align: center;
            color: var(--error-color);
            font-size: 0.9rem;
            padding: 10px;
            background: rgba(229, 57, 53, 0.1);
            border-radius: var(--border-radius-md);
            margin: 10px auto;
            max-inline-size: 50%;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background: var(--surface-primary);
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .settings-panel.active {
            transform: translateX(0);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--surface-tertiary);
        }

        .settings-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-tertiary);
        }

        .settings-group {
            margin-bottom: 25px;
        }

        .settings-group h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        .settings-item {
            margin-bottom: 15px;
        }

        .settings-item label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .settings-item input[type="text"],
        .settings-item input[type="number"],
        .settings-item select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }

        .settings-item input[type="range"] {
            width: 100%;
        }

        .range-value {
            display: block;
            text-align: center;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .api-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            background: var(--surface-tertiary);
            margin-top: 10px;
        }

        .api-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--error-color);
        }

        .api-status-indicator.connected {
            background-color: var(--success-color);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div></div>
            <div class="header-title">
                <div class="ai-logo-container">
                    <svg class="ai-logo" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                        <path fill="#ffffff" d="M256 32C137.3 32 32 137.3 32 256s105.3 224 224 224 224-105.3 224-224S374.7 32 256 32zm-40 352h-32v-32h32v32zm80 0h-32v-32h32v32zm-80-80c-35.3 0-64-28.7-64-64s28.7-64 64-64 64 28.7 64 64-28.7 64-64 64z"/>
                    </svg>
                </div>
                <span>دستیار هوشمند فارسی</span>
            </div>
            <div class="header-controls">
                <div class="model-selector">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                        <path d="M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
                        <circle cx="12" cy="12" r="2"/>
                    </svg>
                    <select id="model-select" aria-label="انتخاب مدل هوش مصنوعی">
                        <option value="openai">GPT-4o</option>
                        <option value="anthropic">Claude 3.5</option>
                    </select>
                </div>
                <button class="header-btn" id="settings-button" title="تنظیمات">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19.4 15C19.1277 15.6171 19.2583 16.3378 19.73 16.82L19.79 16.88C20.1448 17.2354 20.3424 17.7028 20.3424 18.19C20.3424 18.6772 20.1448 19.1446 19.79 19.5C19.4354 19.8548 18.968 20.0524 18.4808 20.0524C17.9936 20.0524 17.5262 19.8548 17.1716 19.5L17.1116 19.44C16.6294 18.9683 15.9087 18.8377 15.2916 19.11C14.6793 19.3773 14.2795 19.9685 14.28 20.61V20.8C14.28 21.7941 13.4741 22.6 12.48 22.6C11.4859 22.6 10.68 21.7941 10.68 20.8V20.71C10.671 20.0557 10.2582 19.4558 9.63 19.19C9.01293 18.9177 8.29216 19.0483 7.81 19.52L7.75 19.58C7.39545 19.9348 6.9281 20.1324 6.4409 20.1324C5.9537 20.1324 5.48635 19.9348 5.1318 19.58C4.77702 19.2254 4.57938 18.758 4.57938 18.2708C4.57938 17.7836 4.77702 17.3162 5.1318 16.9616L5.1918 16.9016C5.66348 16.4194 5.79414 15.6987 5.52 15.0816C5.25268 14.4693 4.66144 14.0695 4.02 14.07H3.8C2.80589 14.07 2 13.2641 2 12.27C2 11.2759 2.80589 10.47 3.8 10.47H3.89C4.54428 10.461 5.1442 10.0482 5.41 9.42C5.6823 8.80293 5.55164 8.08216 5.08 7.6L5.02 7.54C4.66522 7.18545 4.46759 6.71811 4.46759 6.2309C4.46759 5.7437 4.66522 5.27635 5.02 4.9218C5.37455 4.56702 5.8419 4.36938 6.3291 4.36938C6.8163 4.36938 7.28365 4.56702 7.6382 4.9218L7.6982 4.9818C8.18036 5.45348 8.90113 5.58414 9.5182 5.31C10.1305 5.04268 10.5303 4.45144 10.53 3.81V3.7C10.53 2.70589 11.3359 1.9 12.33 1.9C13.3241 1.9 14.13 2.70589 14.13 3.7V3.79C14.13 4.43144 14.5298 5.02268 15.1421 5.29C15.7592 5.56414 16.4799 5.43348 16.9621 4.9618L17.0221 4.9018C17.3766 4.54702 17.844 4.34938 18.3312 4.34938C18.8184 4.34938 19.2857 4.54702 19.6403 4.9018C19.9951 5.25635 20.1927 5.7237 20.1927 6.2109C20.1927 6.6981 19.9951 7.16545 19.6403 7.52L19.5803 7.58C19.1086 8.06216 18.978 8.78293 19.2503 9.4C19.5176 10.0123 20.1089 10.4121 20.7503 10.4116H20.9403C21.9344 10.4116 22.7403 11.2175 22.7403 12.2116C22.7403 13.2057 21.9344 14.0116 20.9403 14.0116H20.8503C20.2089 14.0121 19.6176 14.4119 19.3503 15.0242L19.4 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="header-btn" id="clear-chat" title="پاک کردن چت">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M3 6H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M8 6V4C8 2.89543 8.89543 2 10 2H14C15.1046 2 16 2.89543 16 4V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M5 6L6 22H18L19 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M9 9V19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M15 9V19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="connection-status">
                <div class="status-indicator" id="connection-indicator"></div>
                <span id="connection-text">اتصال...</span>
            </div>
        </div>
        
        <div class="chat-messages" id="chat-messages"></div>
        
        <div class="input-container">
            <button id="stop-generation" class="stop-generation" style="display: none;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <rect x="4" y="4" width="16" height="16" rx="2" fill="currentColor"/>
                </svg>
                توقف تولید پاسخ
            </button>
            
            <div class="input-controls">
                <button class="input-control-btn" id="record-button" title="ضبط صدا">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 1C10.8954 1 10 1.89543 10 3V13C10 14.1046 10.8954 15 12 15C13.1046 15 14 14.1046 14 13V3C14 1.89543 13.1046 1 12 1Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19 10V13C19 16.866 15.866 20 12 20C8.13401 20 5 16.866 5 13V10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 20V23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8 23H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    ضبط صدا
                </button>
                <button class="input-control-btn" id="attach-button" title="پیوست فایل">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 18V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    پیوست فایل
                </button>
                <button class="input-control-btn" id="emoji-button" title="افزودن ایموجی">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8 14C8 14 9.5 16 12 16C14.5 16 16 14 16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 9H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M15 9H15.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    ایموجی
                </button>
            </div>
            
            <div class="input-wrapper">
                <div class="text-input-container">
                    <div id="voice-wave" class="voice-wave" style="display: none;"></div>
                    <textarea id="user-input" placeholder="پیام خود را بنویسید..." rows="1"></textarea>
                    <div id="interim-result" class="interim-result"></div>
                    
                    <button class="send-button" id="send-button" title="ارسال پیام">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M2 12L22 2L12 22L10 14L2 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    
                    <button class="emoji-button" id="emoji-btn" title="افزودن ایموجی">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 14C8 14 9.5 16 12 16C14.5 16 16 14 16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 9H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M15 9H15.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <div class="emoji-picker" id="emoji-picker">
                    <span>😊</span><span>😂</span><span>😍</span><span>😢</span><span>😡</span>
                    <span>👍</span><span>👎</span><span>🙌</span><span>👋</span><span>✨</span>
                    <span>🚀</span><span>🌟</span><span>💡</span><span>❤️</span><span>🎉</span>
                </div>
            </div>
            
            <div id="attachment-preview" class="attachment-preview" style="display: none;">
                <div class="file-icon" id="file-preview-icon"></div>
                <div class="file-info">
                    <span class="file-name" id="file-name"></span>
                    <span class="file-size" id="file-size"></span>
                </div>
                <button class="remove-file" id="remove-file">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            
            <input type="file" id="file-input" class="file-input" accept="*.*" style="display: none;">
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <h2>تنظیمات</h2>
            <button class="close-settings" id="close-settings">&times;</button>
        </div>
        
        <div class="settings-group">
            <h3>تنظیمات API</h3>
            <div class="settings-item">
                <label for="api-url">آدرس API:</label>
                <input type="text" id="api-url" value="http://localhost:5000">
            </div>
            <div class="api-status">
                <span>وضعیت اتصال:</span>
                <div>
                    <span id="api-status-text">قطع</span>
                    <span class="api-status-indicator" id="api-status-indicator"></span>
                </div>
            </div>
        </div>
        
        <div class="settings-group">
            <h3>تنظیمات هوش مصنوعی</h3>
            <div class="settings-item">
                <label for="temperature-slider">دمای خلاقیت: <span id="temperature-value">0.7</span></label>
                <input type="range" id="temperature-slider" min="0" max="1" step="0.1" value="0.7">
            </div>
            <div class="settings-item">
                <label for="max-tokens">حداکثر تعداد توکن‌ها:</label>
                <input type="number" id="max-tokens" value="2000" min="100" max="8000">
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            ENABLE_STREAMING: true,
            CONTINUOUS_SPEECH: true,
            INTERIM_RESULTS: true,
            RECOGNITION_LANG: 'fa-IR',
            API_URL: 'http://localhost:5000/api'
        };

        // DOM Elements
        const DOM = {
            chatMessages: document.getElementById('chat-messages'),
            userInput: document.getElementById('user-input'),
            sendButton: document.getElementById('send-button'),
            recordButton: document.getElementById('record-button'),
            attachButton: document.getElementById('attach-button'),
            fileInput: document.getElementById('file-input'),
            clearChatButton: document.getElementById('clear-chat'),
            attachmentPreview: document.getElementById('attachment-preview'),
            voiceWave: document.getElementById('voice-wave'),
            stopGeneration: document.getElementById('stop-generation'),
            filePreviewIcon: document.getElementById('file-preview-icon'),
            fileName: document.getElementById('file-name'),
            fileSize: document.getElementById('file-size'),
            removeFile: document.getElementById('remove-file'),
            interimResult: document.getElementById('interim-result'),
            emojiButton: document.getElementById('emoji-button'),
            emojiBtnInline: document.getElementById('emoji-btn'),
            emojiPicker: document.getElementById('emoji-picker'),
            modelSelect: document.getElementById('model-select'),
            connectionIndicator: document.getElementById('connection-indicator'),
            connectionText: document.getElementById('connection-text'),
            temperatureSlider: document.getElementById('temperature-slider'),
            temperatureValue: document.getElementById('temperature-value'),
            maxTokens: document.getElementById('max-tokens'),
            apiUrl: document.getElementById('api-url'),
            apiStatusText: document.getElementById('api-status-text'),
            apiStatusIndicator: document.getElementById('api-status-indicator'),
            settingsButton: document.getElementById('settings-button'),
            settingsPanel: document.getElementById('settings-panel'),
            closeSettings: document.getElementById('close-settings')
        };

        // App State
        const state = {
            isRecording: false,
            isGenerating: false,
            currentFile: null,
            abortController: null,
            isConnected: false,
            conversationHistory: [
                {
                    role: "system",
                    content: "شما یک دستیار هوشمند فارسی هستید که به سوالات پاسخ می‌دهید و در تحلیل کد کمک می‌کنید. پاسخ‌ها را به صورت کامل و دقیق ارائه دهید."
                }
            ],
            recognitionActive: false,
            settings: {
                temperature: 0.7,
                maxTokens: 2000,
                model: 'openai',
                apiUrl: 'http://localhost:5000/api'
            }
        };

        // Speech Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = setupSpeechRecognition();

        function setupSpeechRecognition() {
            if (!SpeechRecognition) {
                console.error('تشخیص گفتار در این مرورگر پشتیبانی نمی‌شود.');
                return null;
            }
            
            const instance = new SpeechRecognition();
            instance.lang = config.RECOGNITION_LANG;
            instance.interimResults = config.INTERIM_RESULTS;
            instance.continuous = config.CONTINUOUS_SPEECH;
            instance.maxAlternatives = 5;
            
            instance.onresult = handleSpeechResult;
            instance.onstart = handleSpeechStart;
            instance.onend = handleSpeechEnd;
            instance.onerror = handleSpeechError;
            
            return instance;
        }

        // Event Listeners
        DOM.sendButton.addEventListener('click', sendMessage);
        DOM.userInput.addEventListener('keydown', handleKeyDown);
        DOM.recordButton.addEventListener('click', toggleRecording);
        DOM.attachButton.addEventListener('click', () => DOM.fileInput.click());
        DOM.fileInput.addEventListener('change', handleFileUpload);
        DOM.clearChatButton.addEventListener('click', clearChat);
        DOM.removeFile.addEventListener('click', removeAttachment);
        DOM.stopGeneration.addEventListener('click', stopGeneration);
        DOM.userInput.addEventListener('input', autoResizeTextarea);
        DOM.emojiButton.addEventListener('click', toggleEmojiPicker);
        DOM.emojiBtnInline.addEventListener('click', toggleEmojiPicker);
        DOM.emojiPicker.addEventListener('click', handleEmojiSelect);
        DOM.modelSelect.addEventListener('change', handleModelChange);
        DOM.temperatureSlider.addEventListener('input', handleTemperatureChange);
        DOM.maxTokens.addEventListener('change', handleMaxTokensChange);
        DOM.apiUrl.addEventListener('change', handleApiUrlChange);
        DOM.settingsButton.addEventListener('click', toggleSettings);
        DOM.closeSettings.addEventListener('click', toggleSettings);

        window.addEventListener('load', () => {
            setTimeout(() => {
                DOM.userInput.focus();
            }, 500);
            checkSpeechRecognitionSupport();
            checkServerConnection();
            loadSettings();
            addMessageToUI("سلام! من دستیار هوشمند فارسی شما هستم. چطور می‌توانم امروز به شما کمک کنم؟", 'ai');
        });

        window.addEventListener('click', (e) => {
            if (!DOM.emojiPicker.contains(e.target) && !DOM.emojiButton.contains(e.target) && !DOM.emojiBtnInline.contains(e.target)) {
                DOM.emojiPicker.classList.remove('active');
            }
        });

        // Settings functions
        function toggleSettings() {
            DOM.settingsPanel.classList.toggle('active');
        }

        function loadSettings() {
            // Load from localStorage if available
            const savedSettings = localStorage.getItem('aiChatSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    state.settings = { ...state.settings, ...settings };
                    
                    // Update UI
                    DOM.temperatureSlider.value = state.settings.temperature;
                    DOM.temperatureValue.textContent = state.settings.temperature;
                    DOM.maxTokens.value = state.settings.maxTokens;
                    DOM.modelSelect.value = state.settings.model;
                    DOM.apiUrl.value = state.settings.apiUrl;
                    
                    config.API_URL = state.settings.apiUrl;
                } catch (e) {
                    console.error('خطا در بارگذاری تنظیمات:', e);
                }
            }
        }

        function saveSettings() {
            localStorage.setItem('aiChatSettings', JSON.stringify(state.settings));
        }

        function handleTemperatureChange(e) {
            const value = parseFloat(e.target.value);
            DOM.temperatureValue.textContent = value;
            state.settings.temperature = value;
            saveSettings();
        }

        function handleMaxTokensChange(e) {
            const value = parseInt(e.target.value);
            state.settings.maxTokens = value;
            saveSettings();
        }

        function handleApiUrlChange(e) {
            const value = e.target.value.trim();
            state.settings.apiUrl = value;
            config.API_URL = value;
            saveSettings();
            checkServerConnection();
        }

        function handleModelChange(e) {
            state.settings.model = e.target.value;
            saveSettings();
        }

        // Server Connection
        async function checkServerConnection() {
            try {
                const response = await fetch(`${config.API_URL}/status`);
                if (response.ok) {
                    const data = await response.json();
                    state.isConnected = true;
                    DOM.connectionIndicator.classList.add('online');
                    DOM.connectionText.textContent = 'متصل';
                    DOM.apiStatusIndicator.classList.add('connected');
                    DOM.apiStatusText.textContent = 'متصل';
                    return data;
                }
            } catch (e) {
                console.error('خطا در اتصال به سرور:', e);
            }
            
            state.isConnected = false;
            DOM.connectionIndicator.classList.remove('online');
            DOM.connectionText.textContent = 'قطع';
            DOM.apiStatusIndicator.classList.remove('connected');
            DOM.apiStatusText.textContent = 'قطع';
            
            return null;
        }

        // Message Send Functionality
        async function sendMessage() {
            const message = DOM.userInput.value.trim();
            if (message || state.currentFile) {
                const userMessage = {
                    role: "user",
                    content: state.currentFile ? 
                        `${message}\n\n[فایل پیوست شده: ${state.currentFile.name}]` : 
                        message
                };
                
                addMessageToUI(userMessage.content, 'user');
                state.conversationHistory.push(userMessage);
                
                DOM.userInput.value = '';
                DOM.userInput.style.height = 'auto';
                removeAttachment();
                DOM.interimResult.textContent = '';
                DOM.interimResult.classList.remove('active');
                
                showTypingIndicator();
                DOM.stopGeneration.style.display = 'flex';
                state.isGenerating = true;
                
                if (state.isConnected) {
                    try {
                        await processAIResponse();
                    } catch (error) {
                        console.error('خطا در دریافت پاسخ از API:', error);
                        addMessageToUI('خطا در ارتباط با سرور. لطفاً مجدداً تلاش کنید.', 'error');
                        fallbackResponse(message);
                    }
                } else {
                    fallbackResponse(message);
                }
            }
        }

        // Process AI Response from API
        async function processAIResponse() {
            state.abortController = new AbortController();
            
            try {
                const response = await fetch(`${config.API_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: state.conversationHistory,
                        model: state.settings.model,
                        temperature: state.settings.temperature,
                        max_tokens: state.settings.maxTokens
                    }),
                    signal: state.abortController.signal
                });
                
                if (!response.ok) {
                    throw new Error(`خطای سرور: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Display the response with simulated streaming
                    await simulateStreaming(result.content);
                    
                    // Add to conversation history
                    state.conversationHistory.push({
                        role: "assistant",
                        content: result.content
                    });
                } else {
                    addMessageToUI(`خطا: ${result.error}`, 'error');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    throw error;
                }
            } finally {
                hideTypingIndicator();
                DOM.stopGeneration.style.display = 'none';
                state.isGenerating = false;
                state.abortController = null;
            }
        }

        // Fallback response when API is not available
        function fallbackResponse(message) {
            // Define some responses for common questions
            const defaultResponses = {
                "سلام": "سلام! چطور می‌توانم امروز به شما کمک کنم؟",
                "چطوری": "من خوبم، ممنون از شما! چطور می‌توانم کمکتان کنم؟",
                "خوبی": "بله، ممنون از لطف شما! من آماده‌ام تا به سوالات شما پاسخ دهم.",
                "help": "من می‌توانم به سوالات شما پاسخ دهم، در نوشتن کد کمک کنم، یا اطلاعات مفید در اختیارتان قرار دهم. چه کمکی از من برمی‌آید؟",
                "کمک": "چه کمکی از من برمی‌آید؟ می‌توانم در زمینه‌های مختلف اطلاعات و راهنمایی ارائه دهم.",
                "ممنون": "خواهش می‌کنم! خوشحالم که توانستم کمک کنم.",
                "مرسی": "خواهش می‌کنم! اگر سوال دیگری دارید، خوشحال می‌شوم کمک کنم."
            };

            const loweredMessage = message.toLowerCase();
            
            let responseContent = "متأسفانه در حال حاضر امکان اتصال به سرور وجود ندارد. لطفاً بعداً دوباره تلاش کنید یا تنظیمات اتصال را بررسی کنید.";
            
            // Check for default responses
            for (const [key, value] of Object.entries(defaultResponses)) {
                if (loweredMessage.includes(key)) {
                    responseContent = value;
                    break;
                }
            }
            
            simulateStreaming(responseContent);
            
            // Add to history
            state.conversationHistory.push({
                role: "assistant",
                content: responseContent
            });
        }

        // Simulate Streaming Response
        async function simulateStreaming(content) {
            const messageElement = createMessageElement('', 'ai');
            let currentContent = '';
            let inCodeBlock = false;
            let codeBuffer = '';
            
            // Simulate streaming by chunking the content
            const chunks = chunkContent(content);
            
            for (const chunk of chunks) {
                if (state.abortController && state.abortController.signal.aborted) break;
                
                currentContent += chunk;
                
                if (chunk.includes('```')) {
                    inCodeBlock = !inCodeBlock;
                    codeBuffer += chunk;
                    if (!inCodeBlock) {
                        updateMessageElement(messageElement, currentContent);
                        codeBuffer = '';
                    }
                } else if (inCodeBlock) {
                    codeBuffer += chunk;
                } else {
                    updateMessageElement(messageElement, currentContent);
                }
                
                await new Promise(resolve => setTimeout(resolve, 10 + Math.random() * 30));
            }
            
            hideTypingIndicator();
            DOM.stopGeneration.style.display = 'none';
            state.isGenerating = false;
            state.abortController = null;
        }

        // Helper function to chunk a long string into smaller pieces
        function chunkContent(text) {
            const avgChunkSize = 5;
            const chunks = [];
            let currentIndex = 0;
            
            while (currentIndex < text.length) {
                // Vary chunk size for more natural streaming
                const size = Math.max(1, Math.floor(avgChunkSize + (Math.random() * avgChunkSize)));
                const endIndex = Math.min(text.length, currentIndex + size);
                
                // Check for code block markers to keep them intact
                if (text.substring(currentIndex, currentIndex + 3) === '```') {
                    chunks.push('```');
                    currentIndex += 3;
                } else {
                    chunks.push(text.substring(currentIndex, endIndex));
                    currentIndex = endIndex;
                }
            }
            
            return chunks;
        }

        // Message UI Functions
        function createMessageElement(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `message-content ${sender}-message`;
            contentDiv.innerHTML = processContent(content);
            
            const metadataDiv = document.createElement('div');
            metadataDiv.className = 'message-metadata';
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            
            const timeIcon = document.createElement('span');
            timeIcon.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
            </svg>`;
            
            const timeText = document.createElement('span');
            timeText.textContent = new Date().toLocaleTimeString('fa-IR', {hour: '2-digit', minute:'2-digit'});
            
            timeDiv.appendChild(timeIcon);
            timeDiv.appendChild(timeText);
            
            const senderDiv = document.createElement('div');
            senderDiv.className = `message-sender ${sender}-sender`;
            
            if (sender === 'user') {
                senderDiv.innerHTML = `<span class="sender-icon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                        <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 14C8.13401 14 5 17.134 5 21H19C19 17.134 15.866 14 12 14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>شما`;
            } else {
                let modelName = state.settings.model === 'openai' ? 'GPT-4o' : 'Claude 3.5';
                senderDiv.innerHTML = `<span class="sender-icon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                        <path d="M12 16C15.866 16 19 12.866 19 9C19 5.13401 15.866 2 12 2C8.13401 2 5 5.13401 5 9C5 12.866 8.13401 16 12 16Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 16V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 19H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>${modelName}`;
            }
            
            metadataDiv.appendChild(senderDiv);
            metadataDiv.appendChild(timeDiv);
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(metadataDiv);
            DOM.chatMessages.appendChild(messageDiv);
            
            scrollToBottom();
            return messageDiv;
        }

        function updateMessageElement(element, content) {
            const contentDiv = element.querySelector('.message-content');
            contentDiv.innerHTML = processContent(content);
            scrollToBottom();
        }

        function processContent(content) {
            let processed = content;
            
            processed = processed.replace(/```(\w*)\n([\s\S]*?)```/g, (match, language, code) => {
                const langClass = language ? ` class="language-${language}"` : '';
                return `<pre class="code-block"><code${langClass}>${escapeHtml(code)}</code><button class="copy-code" onclick="copyToClipboard(this)">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 2C6.89543 2 6 2.89543 6 4V16C6 17.1046 6.89543 18 8 18H18C19.1046 18 20 17.1046 20 16V7.41421C20 6.88378 19.7893 6.37507 19.4142 6L16 2.58579C15.6249 2.21071 15.1162 2 14.5858 2H8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M16 18V20C16 21.1046 15.1046 22 14 22H4C2.89543 22 2 21.1046 2 20V8C2 6.89543 2.89543 6 4 6H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    کپی</button></pre>`;
            });
            
            processed = processed.replace(/```([\s\S]*?)```/g, (match, code) => {
                return `<pre class="code-block"><code>${escapeHtml(code)}</code><button class="copy-code" onclick="copyToClipboard(this)">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 2C6.89543 2 6 2.89543 6 4V16C6 17.1046 6.89543 18 8 18H18C19.1046 18 20 17.1046 20 16V7.41421C20 6.88378 19.7893 6.37507 19.4142 6L16 2.58579C15.6249 2.21071 15.1162 2 14.5858 2H8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M16 18V20C16 21.1046 15.1046 22 14 22H4C2.89543 22 2 21.1046 2 20V8C2 6.89543 2.89543 6 4 6H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    کپی</button></pre>`;
            });
            
            processed = processed.replace(/`([^`]+)`/g, '<code>$1</code>');
            processed = processed.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            
            if (!processed.includes('<pre class="code-block">')) {
                if (processed.includes('\n- ') || processed.includes('\n* ')) {
                    const lines = processed.split('\n');
                    let inList = false;
                    let listItems = [];
                    let result = [];
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        if (line.trim().startsWith('- ') || line.trim().startsWith('* ')) {
                            if (!inList) {
                                inList = true;
                                listItems = [];
                            }
                            listItems.push(line.trim().substring(2));
                        } else {
                            if (inList) {
                                inList = false;
                                result.push(`<ul>${listItems.map(item => `<li>${item}</li>`).join('')}</ul>`);
                                listItems = [];
                            }
                            if (line.trim()) {
                                result.push(`<p>${line}</p>`);
                            }
                        }
                    }
                    
                    if (inList) {
                        result.push(`<ul>${listItems.map(item => `<li>${item}</li>`).join('')}</ul>`);
                    }
                    
                    processed = result.join('');
                } else {
                    processed = processed.split('\n').map(part => {
                        return part.trim() ? `<p>${part}</p>` : '';
                    }).join('');
                }
            }
            
            return processed;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Clipboard functions
        window.copyToClipboard = function(button) {
            const codeBlock = button.parentElement;
            const code = codeBlock.querySelector('code').textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 13L9 17L19 7" stroke="#2ecc71" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    کپی شد!
                `;
                button.style.background = 'rgba(46, 204, 113, 0.3)';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
            });
        };

        function addMessageToUI(content, sender) {
            if (sender === 'system') {
                const systemDiv = document.createElement('div');
                systemDiv.className = 'system-message';
                systemDiv.textContent = content;
                DOM.chatMessages.appendChild(systemDiv);
                scrollToBottom();
                return;
            } else if (sender === 'error') {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = content;
                DOM.chatMessages.appendChild(errorDiv);
                scrollToBottom();
                return;
            }
            
            createMessageElement(content, sender);
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <span class="typing-text">در حال تایپ...</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            DOM.chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function stopGeneration() {
            if (state.abortController) {
                state.abortController.abort();
            }
            DOM.stopGeneration.style.display = 'none';
            state.isGenerating = false;
            hideTypingIndicator();
            addMessageToUI('تولید پاسخ متوقف شد', 'system');
        }

        // Voice Recording Functions
        function toggleRecording() {
            if (state.isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!recognition) {
                addMessageToUI('تشخیص گفتار در این مرورگر پشتیبانی نمی‌شود.', 'error');
                return;
            }

            try {
                state.isRecording = true;
                DOM.recordButton.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="7" y="7" width="10" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    توقف
                `;
                DOM.recordButton.style.color = 'var(--error-color)';
                DOM.userInput.placeholder = "در حال گوش دادن... صحبت کنید";
                DOM.voiceWave.style.display = 'flex';
                DOM.interimResult.textContent = '';
                DOM.interimResult.classList.add('active');
                
                createVoiceWave();
                recognition.start();
            } catch (e) {
                console.error('خطا در شروع تشخیص گفتار:', e);
                stopRecording();
                addMessageToUI('مشکلی در راه‌اندازی تشخیص گفتار وجود دارد. لطفاً مجدداً تلاش کنید.', 'error');
                recognition = setupSpeechRecognition();
            }
        }

        function stopRecording() {
            state.isRecording = false;
            DOM.recordButton.innerHTML = `
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 1C10.8954 1 10 1.89543 10 3V13C10 14.1046 10.8954 15 12 15C13.1046 15 14 14.1046 14 13V3C14 1.89543 13.1046 1 12 1Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 10V13C19 16.866 15.866 20 12 20C8.13401 20 5 16.866 5 13V10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 20V23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8 23H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                ضبط صدا
            `;
            DOM.recordButton.style.color = '';
            DOM.userInput.placeholder = "پیام خود را بنویسید...";
            DOM.voiceWave.style.display = 'none';
            DOM.interimResult.classList.remove('active');
            
            try {
                if (state.recognitionActive) {
                    recognition.stop();
                }
            } catch (e) {
                console.error('خطا در توقف تشخیص گفتار:', e);
            }
        }

        function createVoiceWave() {
            DOM.voiceWave.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                const bar = document.createElement('div');
                bar.className = 'wave-bar';
                bar.style.animationDelay = `${i * 0.07}s`;
                bar.style.height = `${Math.random() * 15 + 5}px`;
                DOM.voiceWave.appendChild(bar);
            }
        }

        function handleSpeechResult(event) {
            let interimTranscript = '';
            let finalTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                    if (finalTranscript.trim()) {
                        if (DOM.userInput.value) {
                            DOM.userInput.value += ' ' + finalTranscript;
                        } else {
                            DOM.userInput.value = finalTranscript;
                        }
                        autoResizeTextarea();
                    }
                } else {
                    interimTranscript += transcript;
                }
            }
            
            DOM.interimResult.textContent = interimTranscript;
        }

        function handleSpeechStart() {
            state.recognitionActive = true;
        }

        function handleSpeechEnd() {
            state.recognitionActive = false;
            stopRecording();
        }

        function handleSpeechError(event) {
            console.error('خطای تشخیص گفتار:', event.error);
            stopRecording();
            addMessageToUI(`خطای تشخیص گفتار: ${event.error}`, 'error');
        }

        function checkSpeechRecognitionSupport() {
            if (!SpeechRecognition) {
                DOM.recordButton.disabled = true;
                DOM.recordButton.title = 'تشخیص گفتار پشتیبانی نمی‌شود';
            }
        }

        // Utility Functions
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                state.currentFile = file;
                DOM.attachmentPreview.style.display = 'flex';
                DOM.fileName.textContent = file.name;
                DOM.fileSize.textContent = `${(file.size / 1024).toFixed(2)} KB`;
                DOM.filePreviewIcon.innerHTML = getFileIcon(file.type);
            }
        }

        function getFileIcon(fileType) {
            if (fileType.includes('image')) {
                return '<i class="fas fa-image"></i>';
            } else if (fileType.includes('pdf')) {
                return '<i class="fas fa-file-pdf"></i>';
            } else if (fileType.includes('python')) {
                return '<i class="fas fa-file-code"></i>';
            } else {
                return '<i class="fas fa-file"></i>';
            }
        }

        function removeAttachment() {
            state.currentFile = null;
            DOM.attachmentPreview.style.display = 'none';
            DOM.fileInput.value = '';
        }

        function clearChat() {
            DOM.chatMessages.innerHTML = '';
            state.conversationHistory = [
                {
                    role: "system",
                    content: "شما یک دستیار هوشمند فارسی هستید که به سوالات پاسخ می‌دهید و در تحلیل کد کمک می‌کنید. پاسخ‌ها را به صورت کامل و دقیق ارائه دهید."
                }
            ];
            addMessageToUI("چت پاک شد. از نو شروع کنید!", 'system');
            setTimeout(() => {
                addMessageToUI("سلام! من دستیار هوشمند فارسی شما هستم. چطور می‌توانم به شما کمک کنم؟", 'ai');
            }, 500);
        }

        function autoResizeTextarea() {
            DOM.userInput.style.height = 'auto';
            DOM.userInput.style.height = `${DOM.userInput.scrollHeight}px`;
        }

        function toggleEmojiPicker() {
            DOM.emojiPicker.classList.toggle('active');
        }

        function handleEmojiSelect(event) {
            if (event.target.tagName === 'SPAN') {
                DOM.userInput.value += event.target.textContent;
                DOM.emojiPicker.classList.remove('active');
                autoResizeTextarea();
                DOM.userInput.focus();
            }
        }

        function scrollToBottom() {
            DOM.chatMessages.scrollTop = DOM.chatMessages.scrollHeight;
        }
    </script>
</body>
</html>